@model List<qenem.Models.Question>
@using Markdig
@using System.Text.Json
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager

@{
    ViewData["Title"] = "Questões ENEM";
}

<div class="container mt-4" data-userid="@UserManager.GetUserId(User)" id="container-questoes">

    @if (Model.Any())
    {
        <div class="row">
            <div class="col-2 d-flex flex-column align-items-start" id="botoes-navegacao">
                @for (int i = 0; i < Model.Count; i++)
                {
                    <button class="btn btn-outline-primary rounded-circle mb-2"
                            style="width: 45px; height: 45px;"
                            onclick="mostrarQuestao(@i)">
                        @(i + 1)
                    </button>
                }
            </div>

            <div class="col-10" id="questoes-container">
                @for (int i = 0; i < Model.Count; i++)
                {
                    var questao = Model[i];

                    <div id="questao-@i" class="questao" style="display:@(i == 0 ? "block" : "none")" data-correcta="@questao.correctAlternative">

                        <h4>Questão @(i + 1): @questao.title (@questao.year)</h4>
                        <p><strong>Disciplina:</strong> @questao.discipline</p>
                        @if (!string.IsNullOrEmpty(questao.language))
                        {
                            <p><strong>Língua:</strong> @questao.language</p>
                        }

                        <div>@Html.Raw(Markdown.ToHtml(questao.context ?? ""))</div>
                        <div>@Html.Raw(Markdown.ToHtml(questao.alternativesIntroduction ?? ""))</div>

                        <div class="list-group mt-3">
                            @foreach (var alt in questao.alternatives)
                            {
                                <button class="list-group-item list-group-item-action alternativa"
                                        data-letra="@alt.letter"
                                        onclick="selecionarAlternativa(this, @i)">
                                    <strong>@alt.letter)</strong> @alt.text
                                </button>
                            }
                        </div>

                        <div class="mt-3 d-flex justify-content-between">


                            <button class="btn btn-info" onclick="anterior(@i)" @(i == 0 ? "disabled" : "")>Anterior</button>

                            <button class="btn btn-success" onclick="gerenciarVerificacao(@i)">Verificar</button>

                            @if (i == Model.Count - 1)
                            {
                                <button class="btn btn-primary" onclick="gerarMaisQuestoes()">Gerar Mais</button>
                            }
                            else
                            {
                                <button class="btn btn-info" onclick="proxima(@i)">Próxima</button>
                            }
                        </div>

                        <div class="mt-3">
                            <button class="btn btn-warning" data-id="@questao.UniqueId" onclick='abrirModalAdicionarLista(@Html.Raw(JsonSerializer.Serialize(questao.UniqueId)))'>
                                <i class="fas fa-plus"></i> Adicionar à Lista
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // Executa assim que o documento estiver pronto
        document.addEventListener('DOMContentLoaded', function () {
            // Verifica se o Model passado pelo Controller está vazio
            const modelIsEmpty = @(Model.Any() ? "false" : "true");

            if (modelIsEmpty) {
                Swal.fire({
                    title: 'Nenhuma área de interesse selecionada!',
                    text: 'Você precisa escolher suas áreas de interesse para gerarmos questões personalizadas para você.',
                    icon: 'warning',
                    confirmButtonText: 'Escolher Áreas Agora',
                    allowOutsideClick: false, // Impede que o usuário feche clicando fora
                    allowEscapeKey: false    // Impede que o usuário feche com a tecla ESC
                }).then((result) => {
                    // Se o usuário clicar no botão, redireciona
                    if (result.isConfirmed) {
                        window.location.href = '@Url.Action("AreaInteresse", "Users")';
                    }
                });
            }
        });

        let TOTAL = @Model.Count;

        function abrirModalAdicionarListaFromButton(button) {
            const questaoId = button.getAttribute('data-id');
            console.log("Enviando:", { listaId, questaoId });
            abrirModalAdicionarLista(questaoId);
        }

        function mostrarQuestao(index) {
            document.querySelectorAll('.questao').forEach(q => q.style.display = 'none');
            const div = document.getElementById('questao-' + index);
            if (div) div.style.display = 'block';
        }

        function selecionarAlternativa(btn, questaoIndex) {
            const alternativas = document.querySelectorAll('#questao-' + questaoIndex + ' .alternativa');
            alternativas.forEach(a => a.classList.remove('active'));
            btn.classList.add('active');
        }

        async function gerenciarVerificacao(index) {
            const resultado = verificarResposta(index);
            
            if (resultado === null) {
                return;
            }

            if (resultado) {
                resultadoDaInteracao = await Swal.fire("Parabéns!", "Resposta correta!", "success");
            } else {
                const correta = document.getElementById('questao-' + index).dataset.correcta;
                resultadoDaInteracao = await Swal.fire("Incorreto", "A resposta correta é: " + correta, "error");
            }
        }

        function verificarResposta(index) {
            const questaoDiv = document.getElementById('questao-' + index);
            if (!questaoDiv) return;
            const correta = questaoDiv.dataset.correcta;
            const selecionada = questaoDiv.querySelector('.alternativa.active');

            if (!selecionada) {
                Swal.fire("Atenção", "Selecione uma alternativa antes de verificar.", "warning");
                return;
            }

            const letraSelecionada = selecionada.dataset.letra;

            return letraSelecionada === correta;
        }

        async function GravarPontos(index) {
            const resultado = verificarResposta(index);

            if (resultado === null) {
                return;
            }
        if (resultado) {
                // 1. Obter o ID do usuário que armazenamos no atributo data-*
                const container = document.getElementById('container-questoes');
                const userId = container ? container.dataset.userid : null;

                if (!userId) {
                    console.error("Não foi possível encontrar o ID do usuário na página.");
                    Swal.fire("Erro", "Não foi possível identificar o usuário. Tente recarregar a página.", "error");
                    return;
                }

                try {
                    // 2. Montar e executar a chamada fetch
                    const response = await fetch('/Pontos/PontosQuestoes', {
                        method: 'POST',
                        headers: {
                            // Para enviar dados simples como este, 'x-www-form-urlencoded' funciona muito bem
                            // e é facilmente entendido pelo ASP.NET Core.
                            'Content-Type': 'application/x-www-form-urlencoded',
                            // Adicionar o RequestVerificationToken é uma boa prática de segurança contra ataques CSRF
                            //'RequestVerificationToken': document.getElementsByName('__RequestVerificationToken')[0].value
                        },
                        // 3. Montar o corpo da requisição
                        body: `idUsuario=${encodeURIComponent(userId)}`
                    });

                    // 4. Analisar a resposta do servidor
                    const resultData = await response.json();

                    if (response.ok && resultData.success) {
                        // Sucesso! O servidor retornou uma resposta positiva.
                        console.log(resultData.message); // Exibe "Pontuação adicionada com sucesso!"
                        Swal.fire("Sucesso!", resultData.message, "success");
                    } else {
                        // O servidor respondeu, mas com um erro (ex: status 500 ou success=false)
                        Swal.fire("Erro", resultData.message || "Não foi possível registrar a pontuação.", "error");
                    }

                } catch (error) {
                    // Erro de rede ou falha na comunicação
                    console.error("Falha na requisição fetch:", error);
                    Swal.fire("Erro de Conexão", "Não foi possível se comunicar com o servidor.", "error");
                }
            }
        }

        function proxima(index) {
            GravarPontos(index);
            if (index + 1 < TOTAL) mostrarQuestao(index + 1);
        }

        function anterior(index) {
            if (index - 1 >= 0) mostrarQuestao(index - 1);
        }

        function gerarMaisQuestoes() {
            Swal.fire({ title: 'Buscando novas questões...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            fetch('/ListarQuestoes/GerarQuestoesMock', { method: 'POST' })
                .then(response => {
                    if (!response.ok) throw new Error("Erro na rede.");
                    return response.json();
                })
                .then(novasQuestoes => {
                    if (novasQuestoes && novasQuestoes.length > 0) {
                        atualizarQuestoes(novasQuestoes);
                        Swal.close();
                    } else {
                        Swal.fire('Aviso', 'Não foi possível carregar novas questões.', 'warning');
                    }
                })
                .catch(error => {
                    console.error("Erro em gerarMaisQuestoes:", error);
                    Swal.fire('Erro', 'Ocorreu um problema ao buscar as questões.', 'error');
                });
        }

        function escapeJs(str) {
            if (typeof str !== 'string' || !str) return '';
            return str.replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\${/g, '\\${');
        }
        function escapeHtml(str) {
            if (typeof str !== 'string') return '';
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }


        function atualizarQuestoes(questoes) {
            const containerBotoes = document.getElementById('botoes-navegacao');
            const containerQuestoes = document.getElementById('questoes-container');
            if (!containerBotoes || !containerQuestoes) return;

            // Atualiza os botões de navegação
            containerBotoes.innerHTML = '';
            questoes.forEach((q, i) => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-outline-primary rounded-circle mb-2';
                btn.style.width = '45px';
                btn.style.height = '45px';
                btn.textContent = i + 1;
                btn.onclick = () => mostrarQuestao(i);
                containerBotoes.appendChild(btn);
            });

            // Atualiza as questões
            containerQuestoes.innerHTML = '';
            questoes.forEach((questao, i) => {
                const divQuestao = document.createElement('div');
                divQuestao.id = `questao-${i}`;
                divQuestao.className = 'questao';
                divQuestao.style.display = i === 0 ? 'block' : 'none';
                divQuestao.dataset.correcta = questao.correctAlternative;

                // Conteúdo da questão
                const html = `
                    <h4>Questão ${i + 1}: ${escapeHtml(questao.title)} (${questao.year})</h4>
                    <p><strong>Disciplina:</strong> ${escapeHtml(questao.discipline)}</p>
                    ${questao.language ? `<p><strong>Língua:</strong> ${escapeHtml(questao.language)}</p>` : ''}
                    <div>${escapeHtml(questao.context)}</div>
                    <div>${escapeHtml(questao.alternativesIntroduction)}</div>
                    <div class="list-group mt-3">
                        ${Array.isArray(questao.alternatives) ? questao.alternatives.map(alt => `
                            <button class="list-group-item list-group-item-action alternativa"
                                    data-letra="${alt.letter}"
                                    onclick="selecionarAlternativa(this, ${i})">
                                <strong>${alt.letter})</strong> ${escapeHtml(alt.text)}
                            </button>
                        `).join('') : ''}
                    </div>
                    <div class="mt-3 d-flex justify-content-between">
                        <button class="btn btn-info" onclick="anterior(${i})">Anterior</button>
                        <button class="btn btn-success" onclick="verificarResposta(${i})">Verificar</button>
                        ${i === questoes.length - 1
                            ? `<button class="btn btn-primary" onclick="gerarMaisQuestoes()">Gerar Mais</button>`
                            : `<button class="btn btn-info" onclick="proxima(${i})">Próxima</button>`}
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-warning" onclick='abrirModalAdicionarLista(${JSON.stringify(questao.uniqueId)})'>
                            <i class="fas fa-plus"></i> Adicionar à Lista
                        </button>
                    </div>
                `;

                divQuestao.innerHTML = html;
                containerQuestoes.appendChild(divQuestao);
            });

            window.TOTAL = questoes.length;
        }


        async function abrirModalAdicionarLista(questaoId) {
            try {
                Swal.fire({ title: 'Buscando suas listas...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                const response = await fetch('@Url.Action("ObterListasDoUsuario", "Lista")');
                if (!response.ok) throw new Error('Falha na comunicação com o servidor.');
                const listas = await response.json();

                if (listas && listas.length > 0) {
                    mostrarModalDeSelecao(listas, questaoId);
                } else {
                    mostrarModalCriarLista(questaoId);
                }
            } catch (error) {
                console.error("Erro ao buscar listas:", error);
                Swal.fire('Erro!', 'Não foi possível carregar suas listas.', 'error');
            }
        }

        async function mostrarModalDeSelecao(listas, questaoId) {
            const selectOptionsHtml = listas.map(lista => `<option value="${lista.id}">${lista.nome}</option>`).join('');
            const modalHtml = `<select id="swal-select-lista" class="swal2-select"><option value="" disabled selected>Selecione uma de suas listas</option>${selectOptionsHtml}</select>`;

            const result = await Swal.fire({
                title: 'Adicionar questão à lista',
                html: modalHtml,
                showCancelButton: true,
                confirmButtonText: 'Adicionar',
                cancelButtonText: 'Cancelar',
                showDenyButton: true,
                denyButtonText: 'Criar nova lista',
                preConfirm: () => {
                    const selectElement = document.getElementById('swal-select-lista');
                    if (!selectElement.value) {
                        Swal.showValidationMessage('Por favor, selecione uma lista.');
                        return false;
                    }
                    return selectElement.value;
                }
            });

            if (result.isConfirmed) {
                adicionarQuestaoNaLista(parseInt(result.value), questaoId);
            } else if (result.isDenied) {
                abrirModalCriarNovaLista(questaoId);
            }
        }

        function mostrarModalCriarLista(questaoId) {
            Swal.fire({
                title: 'Nenhuma lista encontrada',
                text: "Você precisa criar uma lista para adicionar questões.",
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'Criar uma lista agora',
                cancelButtonText: 'Fechar'
            }).then((result) => {
                if (result.isConfirmed) {
                    abrirModalCriarNovaLista(questaoId);
                }
            });
        }

        async function abrirModalCriarNovaLista(questaoId) {
            const { value: nomeLista } = await Swal.fire({
                title: 'Criar nova lista',
                input: 'text',
                inputLabel: 'Nome da lista',
                inputPlaceholder: 'Ex: Questões de Biologia',
                showCancelButton: true,
                confirmButtonText: 'Salvar e Adicionar',
                cancelButtonText: 'Cancelar',
                inputValidator: (value) => {
                    if (!value || value.trim().length < 3) {
                        return 'O nome precisa ter pelo menos 3 caracteres.'
                    }
                }
            });

            if (nomeLista) {
                try {
                    Swal.fire({ title: 'Criando lista...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                    const response = await fetch('@Url.Action("CriarListaAjax", "Lista")', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ Nome: nomeLista })
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        const novaListaId = result.lista.id;
                        adicionarQuestaoNaLista(novaListaId, questaoId);
                    } else {
                        Swal.fire('Erro!', result.message, 'error');
                    }

                } catch (error) {
                    console.error("Erro ao criar lista via AJAX:", error);
                    Swal.fire('Erro!', 'Não foi possível se comunicar com o servidor.', 'error');
                }
            }
        }

        async function adicionarQuestaoNaLista(listaId, questaoId) {
            try {
                Swal.fire({ title: 'Adicionando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                const response = await fetch('@Url.Action("AdicionarQuestao", "Lista")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ListaId: listaId, QuestaoId: questaoId })
                });
                const result = await response.json();

                if (response.ok && result.success) {
                    Swal.fire('Sucesso!', result.message, 'success');
                } else {
                    Swal.fire('Atenção!', result.message || 'Ocorreu um problema.', 'warning');
                }
            } catch (error) {
                console.error("Erro ao adicionar questão:", error);
                Swal.fire('Erro!', 'Ocorreu um erro inesperado.', 'error');
            }
        }
    </script>
}